<tal:economies repeat="economy registered_economies"
               define="banned_cargos doc_helper.get_cargoflow_banned_cargos(); supply_cargos doc_helper.get_cargoflow_supply_cargos()">
digraph ${doc_helper.get_economy_name_char_safe(economy)} {
    fontname="sans-serif"
    stylesheet="static/css/cargoflow_styles.css"
    rankdir="LR"
    ranksep="0.88"
    nodesep="0.88"
    newrank=true
    overlap="compress"
    output="edgesfirst"
    tooltip="${doc_helper.get_economy_name(economy)}"

    <tal:cargos repeat="cargo sorted(economy_schemas[economy].enabled_cargos, key=doc_helper.get_cargo_name)">
        <tal:not_banned condition="(cargo.id not in banned_cargos) and (cargo.id not in doc_helper.get_cargoflow_supply_cargos())">
            C_${cargo.id} [
                shape="box"
                label="${doc_helper.get_cargo_name(cargo)}"
                href="cargos.html#${cargo.id}"
                target="_top"
                fontname="sans-serif"
                fontcolor=white
                fontsize=32
                style="filled"
                labelloc=c
                color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                id="${cargo.id}"
            ]
        </tal:not_banned>
    </tal:cargos>

    <tal:industries repeat="industry sorted(economy_schemas[economy].enabled_industries, key=doc_helper.get_industry_name)">
        <tal:not_town_industries condition="not: getattr(industry, 'town_industry_for_cargoflow', False)">
            I_${industry.id} [
                shape=none
                fontsize=32
                label=<
                    <table border="0" cellborder="1" cellspacing="0" cellpadding="0" COLOR="azure3">
                        <tr><td><IMG SRC="static/img/industries/${industry.id}.png" /></td></tr>
                        <!--! nested table for text offers more control + better appearance -->
                        <tr><td><table BGCOLOR="ghostwhite" border="0" cellborder="0" cellspacing="5" cellpadding="0">
                            <tr><td>${doc_helper.get_industry_name(industry, economy)}</td></tr>
                            <tal:cargos repeat="cargo doc_helper.cargos_accepted_by_industry(industry, economy)">
                                 <tal:supplies condition="cargo.id in supply_cargos">
                                    <tr><td><font POINT-SIZE="20">Requires ${doc_helper.get_cargo_name(cargo)}</font></td></tr>
                                </tal:supplies>
                                <tal:banned condition="(cargo.id in banned_cargos) and not getattr(industry, 'town_industry_for_cargoflow', False)">
                                    <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                </tal:banned>
                                <tal:town_industries condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                                    <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                </tal:town_industries>
                            </tal:cargos>
                            <tal:produced_cargos repeat="cargo doc_helper.cargos_produced_by_industry(industry, economy)">
                                <tal:supply_output condition="cargo.id in doc_helper.get_cargoflow_supply_cargos()">
                                    <tr><td><font POINT-SIZE="20">Produces ${doc_helper.get_cargo_name(cargo)}</font></td></tr>
                                </tal:supply_output>
                            </tal:produced_cargos>
                        </table></td></tr>
                    </table>
                >
                id="${industry.id}"
                href="industries.html#${industry.id}" target="_top" fontname="sans-serif"
                tooltip="${doc_helper.get_industry_name(industry, economy)}"
            ]
        </tal:not_town_industries>

        <tal:not_town_industries condition="not: getattr(industry, 'town_industry_for_cargoflow', False)">
            <tal:accepted_cargos repeat="cargo doc_helper.cargos_accepted_by_industry(industry, economy)">
                <tal:not_banned condition="(cargo.id not in banned_cargos) and (cargo.id not in supply_cargos)">
                    C_${cargo.id} -> ${"T_town_industries" if getattr(industry, 'town_industry_for_cargoflow', False) else "I_" + industry.id} [
                        weight="${len(doc_helper.cargos_accepted_by_industry(industry, economy))}"
                        tooltip="${doc_helper.get_cargo_name(cargo)} -> ${doc_helper.get_industry_name(industry, economy)}"
                        color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                        arrowsize=2
                        arrowhead=normal
                        penwidth=5
                        <tal:head_is_cluster condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                            lhead="cluster_town_industries"
                            style="invis"
                        </tal:head_is_cluster>

                    ]
                </tal:not_banned>
            </tal:accepted_cargos>
            <tal:produced_cargos repeat="cargo doc_helper.cargos_produced_by_industry(industry, economy)">
                <!--!<tal:supply_output condition="cargo.id in doc_helper.get_cargoflow_supply_cargos()">
                    I_${industry.id} -> C_${cargo.id}_${industry.id} [
                        weight="${len(doc_helper.cargos_produced_by_industry(industry, economy))}"
                        tooltip="${doc_helper.get_industry_name(industry, economy)} -> ${doc_helper.get_cargo_name(cargo)}"
                        color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                        dir=back
                        arrowtail=nonenoneinv
                        arrowsize=2
                        penwidth=3
                    ]
                    C_${cargo.id}_${industry.id} [
                        shape="ellipse"
                        label="${doc_helper.get_cargo_name(cargo)}"
                        href="cargos.html#${cargo.id}"
                        target="_top"
                        fontname="sans-serif"
                        id="${cargo.id}"
                    ]
                </tal:supply_output>-->
                <tal:not_banned condition="(cargo.id not in banned_cargos) and (cargo.id not in doc_helper.get_cargoflow_supply_cargos())">
                    I_${industry.id} -> C_${cargo.id} [
                        weight="${len(doc_helper.cargos_produced_by_industry(industry, economy))}"
                        tooltip="${doc_helper.get_industry_name(industry, economy)} -> ${doc_helper.get_cargo_name(cargo)}"
                        color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                        dir=back
                        arrowtail=none
                        #arrowtail=nonenoneinv
                        arrowsize=2
                        penwidth=5
                    ]
                </tal:not_banned>
            </tal:produced_cargos>
        </tal:not_town_industries>
    </tal:industries>

    T_towns_food [
        shape="box"
        label="Towns"
        fontname="sans-serif"
        fontcolor=orange
        fontsize=32
        color=orange
        penwidth=5
        margin=0.33
    ]
    C_food -> T_towns_food [
        color=orange
        penwidth=5
        arrowsize=2
    ]
    subgraph cluster_town_industries {
        color="azure3"
        style="filled"
        fillcolor="azure2"
        rank=same
        position="0,0!"
        T_town_industries [
            position="0,0!"
            shape="none"
            label="Town Industries"
            fontname="sans-serif"
            fontcolor=black
            fontsize=32
        ]
        <tal:industries repeat="industry sorted(economy_schemas[economy].enabled_industries, key=doc_helper.get_industry_name)">
            <tal:town_industries condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                I_${industry.id} [
                    shape=none
                    label=<
                        <table border="0" cellborder="1" cellspacing="0" cellpadding="0" COLOR="azure3">
                            <tr><td><table BGCOLOR="ghostwhite" border="0" cellborder="0" cellspacing="5" cellpadding="0">
                                <tr><td><IMG SRC="static/img/industries/${industry.id}.png" /></td></tr>
                                <tr><td>${doc_helper.get_industry_name(industry, economy)}</td></tr>
                                <tal:cargos repeat="cargo doc_helper.cargos_accepted_by_industry(industry, economy)">
                                     <tal:supplies condition="cargo.id in supply_cargos">
                                        <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                    </tal:supplies>
                                    <tal:banned condition="(cargo.id in banned_cargos) and not getattr(industry, 'town_industry_for_cargoflow', False)">
                                        <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                    </tal:banned>
                                    <tal:town_industries condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                                        <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                    </tal:town_industries>
                                </tal:cargos>
                            </table></td></tr>
                        </table>
                    >
                    id="${industry.id}"
                    href="industries.html#${industry.id}"
                    target="_top"
                    fontname="sans-serif"
                    tooltip="${doc_helper.get_industry_name(industry, economy)}"
                ]
            </tal:town_industries>
        </tal:industries>
    }
    <tal:economy_tweaks switch="economy.id">
        <tal:force_steeltown case="'STEELTOWN'">
            <!--! as of March 30th 2021, this is really as optimised as can be
                  the pacemaker is the salt -> chlor-alkali -> acid chain which requires 15 steps in horizontal rank
                  this limits how big the font / industry images can be
                  I've tried using vertical edges or reversed edges to cut the number of steps, but it makes the overall flow less legible
            -->
            { group="cabbage"; I_basic_oxygen_furnace, I_electric_arc_furnace}
            { group="cabbage2"; C_pig_iron}
        </tal:force_steeltown>
        <tal:force_iahc case="'IN_A_HOT_COUNTRY'">
            <!--! temporary patch up, needs more work -->
            N_force_rank [shape=none, style="invis"]
            edge [style="invis"]
            I_supply_yard -> T_town_industries
            I_supply_yard -> N_force_rank
        </tal:force_iahc>
    </tal:economy_tweaks>
    <!--! economy specific tuning - this supports
          1. ranking subgraphs, to force nodes to the same rank
          2. explicit clusters which physically group nodes
          Generally doing more than that is not advised, and will require manual tweaks directly inside the cargoflow
    -->
    <tal:subgraphs repeat="ranking_subgraph economy.cargoflow_graph_tuning['ranking_subgraphs']">
        { rank=${ranking_subgraph[0]}; ${', '.join(ranking_subgraph[1])}}
    </tal:subgraphs>
    <tal:clusters repeat="cluster economy.cargoflow_graph_tuning['clusters']">
        subgraph cluster_${economy.id}_${repeat.cluster.index} {
            <!--! optional color for cluster - could later be replaced by a style class somehow? -->
            <tal:optional_color condition="cluster.get('color', False)">
                color=${cluster['color']}
            </tal:optional_color>
            <!--! optionally force all nodes in this cluster to same rank -->
            <tal:optional_rank condition="cluster.get('rank', False)">
                rank=${cluster['rank']}
            </tal:optional_rank>
            <tal:nodes repeat="node cluster['nodes']">
                ${node}
            </tal:nodes>
        }
    </tal:clusters>
}
</tal:economies>
