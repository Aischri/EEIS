<tal:economies repeat="economy registered_economies"
               define="banned_cargos doc_helper.get_cargoflow_banned_cargos(); supply_cargos doc_helper.get_cargoflow_supply_cargos()">
digraph ${doc_helper.get_economy_name_char_safe(economy)} {
    fontname="sans-serif"
    stylesheet="static/css/cargoflow_styles.css"
    rankdir="LR"
    ranksep="0.88"
    nodesep="0.88"
    newrank=true
    compound=true
    tooltip="${doc_helper.get_economy_name(economy)}"

    <tal:cargos repeat="cargo sorted(economy_schemas[economy].enabled_cargos, key=doc_helper.get_cargo_name)">
        <tal:not_banned condition="(cargo.id not in banned_cargos) and (cargo.id not in doc_helper.get_cargoflow_supply_cargos())">
            C_${cargo.id} [
                shape="box"
                label="${doc_helper.get_cargo_name(cargo)}"
                href="cargos.html#${cargo.id}"
                target="_top"
                fontname="sans-serif"
                fontcolor=white
                fontsize=32
                style="filled"
                labelloc=c
                color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                id="${cargo.id}"
            ]
        </tal:not_banned>
    </tal:cargos>

    <tal:industries repeat="industry sorted(economy_schemas[economy].enabled_industries, key=doc_helper.get_industry_name)">
        <tal:not_town_industries condition="not: getattr(industry, 'town_industry_for_cargoflow', False)">
            I_${industry.id} [
                shape=none
                fontsize=32
                label=<
                    <table border="0" cellborder="1" cellspacing="0" cellpadding="0" COLOR="azure3">
                        <tr><td><IMG SRC="static/img/industries/${industry.id}.png" /></td></tr>
                        <!--! nested table for text offers more control + better appearance -->
                        <tr><td><table BGCOLOR="ghostwhite" border="0" cellborder="0" cellspacing="5" cellpadding="0">
                            <tr><td>${doc_helper.get_industry_name(industry, economy)}</td></tr>
                            <tal:cargos repeat="cargo doc_helper.cargos_accepted_by_industry(industry, economy)">
                                 <tal:supplies condition="cargo.id in supply_cargos">
                                    <tr><td><font POINT-SIZE="20">Requires ${doc_helper.get_cargo_name(cargo)}</font></td></tr>
                                </tal:supplies>
                                <tal:banned condition="(cargo.id in banned_cargos) and not getattr(industry, 'town_industry_for_cargoflow', False)">
                                    <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                </tal:banned>
                                <tal:town_industries condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                                    <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                </tal:town_industries>
                            </tal:cargos>
                            <tal:produced_cargos repeat="cargo doc_helper.cargos_produced_by_industry(industry, economy)">
                                <tal:supply_output condition="cargo.id in doc_helper.get_cargoflow_supply_cargos()">
                                    <tr><td><font POINT-SIZE="20">Produces ${doc_helper.get_cargo_name(cargo)}</font></td></tr>
                                </tal:supply_output>
                            </tal:produced_cargos>
                        </table></td></tr>
                    </table>
                >
                id="${industry.id}"
                href="industries.html#${industry.id}" target="_top" fontname="sans-serif"
                tooltip="${doc_helper.get_industry_name(industry, economy)}"
            ]
        </tal:not_town_industries>

        <!--!<tal:not_town_industries condition="not: getattr(industry, 'town_industry_for_cargoflow', False)">-->
            <tal:accepted_cargos repeat="cargo doc_helper.cargos_accepted_by_industry(industry, economy)">
                <tal:not_banned condition="(cargo.id not in banned_cargos) and (cargo.id not in supply_cargos)">
                    C_${cargo.id} -> ${"T_town_industries" if getattr(industry, 'town_industry_for_cargoflow', False) else "I_" + industry.id} [
                        weight="${len(doc_helper.cargos_accepted_by_industry(industry, economy))}"
                        tooltip="${doc_helper.get_cargo_name(cargo)} -> ${doc_helper.get_industry_name(industry, economy)}"
                        color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                        arrowsize=2
                        arrowhead=normal
                        penwidth=6
                        <tal:head_is_cluster condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                            lhead="cluster_town_industries"
                            style="invis"
                        </tal:head_is_cluster>

                    ]
                </tal:not_banned>
            </tal:accepted_cargos>
            <tal:produced_cargos repeat="cargo doc_helper.cargos_produced_by_industry(industry, economy)">
                <!--!<tal:supply_output condition="cargo.id in doc_helper.get_cargoflow_supply_cargos()">
                    I_${industry.id} -> C_${cargo.id}_${industry.id} [
                        weight="${len(doc_helper.cargos_produced_by_industry(industry, economy))}"
                        tooltip="${doc_helper.get_industry_name(industry, economy)} -> ${doc_helper.get_cargo_name(cargo)}"
                        color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                        dir=back
                        arrowtail=nonenoneinv
                        arrowsize=2
                        penwidth=3
                    ]
                    C_${cargo.id}_${industry.id} [
                        shape="ellipse"
                        label="${doc_helper.get_cargo_name(cargo)}"
                        href="cargos.html#${cargo.id}"
                        target="_top"
                        fontname="sans-serif"
                        id="${cargo.id}"
                    ]
                </tal:supply_output>-->
                <tal:not_banned condition="(cargo.id not in banned_cargos) and (cargo.id not in doc_helper.get_cargoflow_supply_cargos())">
                    I_${industry.id} -> C_${cargo.id} [
                        weight="${len(doc_helper.cargos_produced_by_industry(industry, economy))}"
                        tooltip="${doc_helper.get_industry_name(industry, economy)} -> ${doc_helper.get_cargo_name(cargo)}"
                        color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                        dir=back
                        arrowtail=nonenoneinv
                        arrowsize=2
                        penwidth=6
                    ]
                </tal:not_banned>
            </tal:produced_cargos>
        <!--!</tal:not_town_industries>-->
    </tal:industries>

    subgraph cluster_town_industries {
        color="azure3"
        style="filled"
        fillcolor="azure2"
        rank="max";
        T_town_industries [
            shape="box"
            label="Towns"
            fontname="sans-serif"
            fontcolor=black
            fontsize=32
            style="filled"
        ]
        <!--!
        <tal:industries repeat="industry sorted(economy_schemas[economy].enabled_industries, key=doc_helper.get_industry_name)">
            <tal:town_industries condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                I_${industry.id} [
                    shape=none
                    label=<
                        <table border="0" cellborder="1" cellspacing="0" cellpadding="0" COLOR="azure3">
                            <tr><td><table BGCOLOR="ghostwhite" border="0" cellborder="0" cellspacing="5" cellpadding="0">
                                <tr><td>${doc_helper.get_industry_name(industry, economy)}</td></tr>
                                <tal:cargos repeat="cargo doc_helper.cargos_accepted_by_industry(industry, economy)">
                                     <tal:supplies condition="cargo.id in supply_cargos">
                                        <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                    </tal:supplies>
                                    <tal:banned condition="(cargo.id in banned_cargos) and not getattr(industry, 'town_industry_for_cargoflow', False)">
                                        <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                    </tal:banned>
                                    <tal:town_industries condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                                        <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                    </tal:town_industries>
                                </tal:cargos>
                            </table></td></tr>
                        </table>
                    >
                    id="${industry.id}"
                    href="industries.html#${industry.id}"
                    target="_top"
                    fontname="sans-serif"
                    tooltip="${doc_helper.get_industry_name(industry, economy)}"
                ]
            </tal:town_industries>
        </tal:industries>
        -->
    }
    <tal:force_rankings condition="economy.id == 'STEELTOWN'">
        { group="cabbage2"; I_engine_plant, I_glass_works}
        { group="cabbage3"; I_chlor_alkali_plant}
        { rank=source; I_farm, I_potash_mine, I_soda_ash_mine, I_iron_ore_mine, I_limestone_mine, I_quarry, I_coal_mine, C_coal, I_coke_oven}
        { rank=same; C_chlorine, I_chlor_alkali_plant, C_iron_ore, C_limestone}
        { rank=same; I_electric_arc_furnace, I_basic_oxygen_furnace}
        { rank=same; C_cast_iron, C_aluminium, C_sand}
        { rank=same; I_blast_furnace, I_cryo_plant, I_lime_kiln, I_junk_yard}
        { rank=same; I_wire_and_section_mill, I_sheet_and_pipe_mill}
        { rank=same; I_glass_works, I_engine_plant, C_acid, C_slag}
        { rank=same; C_steel_sections, C_cleaning_agents, C_zinc, C_pipe, C_cement, C_plastics, C_steel_wire_rod, C_alloy_steel, C_stainless_steel}
        { rank=same; I_body_plant, I_component_factory, I_wharf}
        { rank=same;  C_tyres, C_vehicle_engines}
        { rank=sink; I_assembly_plant, T_town_industries, C_vehicles}
    </tal:force_rankings>
}
</tal:economies>
