<tal:economies repeat="economy registered_economies"
               define="banned_cargos doc_helper.get_cargoflow_banned_cargos(); supply_cargos doc_helper.get_cargoflow_supply_cargos()">
digraph ${doc_helper.get_economy_name_char_safe(economy)} {
    fontname="sans-serif"
    stylesheet="static/css/cargoflow_styles.css"
    rankdir="LR"
    ranksep="0.88"
    nodesep="0.88"
    newrank=true
    overlap="compress"
    output="edgesfirst"
    tooltip="${doc_helper.get_economy_name(economy)}"

    <tal:cargos repeat="cargo sorted(economy_schemas[economy].enabled_cargos, key=doc_helper.get_cargo_name)">
        <tal:not_banned condition="(cargo.id not in banned_cargos) and (cargo.id not in doc_helper.get_cargoflow_supply_cargos())">
            C_${cargo.id} [
                shape="box"
                label="${doc_helper.get_cargo_name(cargo)}"
                href="cargos.html#${cargo.id}"
                target="_top"
                fontname="sans-serif"
                fontcolor=white
                fontsize=32
                style="filled"
                labelloc=c
                color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                id="${cargo.id}"
            ]
        </tal:not_banned>
    </tal:cargos>

    <tal:industries repeat="industry sorted(economy_schemas[economy].enabled_industries, key=doc_helper.get_industry_name)">
        <tal:not_town_industries condition="not: getattr(industry, 'town_industry_for_cargoflow', False)">
            I_${industry.id} [
                shape=none
                fontsize=32
                label=<
                    <table border="0" cellborder="1" cellspacing="0" cellpadding="0" COLOR="azure3">
                        <tr><td><IMG SRC="static/img/industries/${industry.id}.png" /></td></tr>
                        <!--! nested table for text offers more control + better appearance -->
                        <tr><td><table BGCOLOR="ghostwhite" border="0" cellborder="0" cellspacing="5" cellpadding="0">
                            <tr><td>${doc_helper.get_industry_name(industry, economy)}</td></tr>
                            <tal:cargos repeat="cargo doc_helper.cargos_accepted_by_industry(industry, economy)">
                                 <tal:supplies condition="cargo.id in supply_cargos">
                                    <tr><td><font POINT-SIZE="20">Requires ${doc_helper.get_cargo_name(cargo)}</font></td></tr>
                                </tal:supplies>
                                <tal:banned condition="(cargo.id in banned_cargos) and not getattr(industry, 'town_industry_for_cargoflow', False)">
                                    <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                </tal:banned>
                                <tal:town_industries condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                                    <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                </tal:town_industries>
                            </tal:cargos>
                            <tal:produced_cargos repeat="cargo doc_helper.cargos_produced_by_industry(industry, economy)">
                                <tal:supply_output condition="cargo.id in doc_helper.get_cargoflow_supply_cargos()">
                                    <tr><td><font POINT-SIZE="20">Produces ${doc_helper.get_cargo_name(cargo)}</font></td></tr>
                                </tal:supply_output>
                            </tal:produced_cargos>
                        </table></td></tr>
                    </table>
                >
                id="${industry.id}"
                href="industries.html#${industry.id}" target="_top" fontname="sans-serif"
                tooltip="${doc_helper.get_industry_name(industry, economy)}"
            ]
        </tal:not_town_industries>

        <tal:not_town_industries condition="not: getattr(industry, 'town_industry_for_cargoflow', False)">
            <tal:accepted_cargos repeat="cargo doc_helper.cargos_accepted_by_industry(industry, economy)">
                <tal:not_banned condition="(cargo.id not in banned_cargos) and (cargo.id not in supply_cargos)">
                    C_${cargo.id} -> ${"T_town_industries" if getattr(industry, 'town_industry_for_cargoflow', False) else "I_" + industry.id} [
                        weight="${len(doc_helper.cargos_accepted_by_industry(industry, economy))}"
                        tooltip="${doc_helper.get_cargo_name(cargo)} -> ${doc_helper.get_industry_name(industry, economy)}"
                        color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                        arrowsize=2
                        arrowhead=normal
                        penwidth=5
                        <tal:head_is_cluster condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                            lhead="cluster_town_industries"
                            style="invis"
                        </tal:head_is_cluster>

                    ]
                </tal:not_banned>
            </tal:accepted_cargos>
            <tal:produced_cargos repeat="cargo doc_helper.cargos_produced_by_industry(industry, economy)">
                <!--!<tal:supply_output condition="cargo.id in doc_helper.get_cargoflow_supply_cargos()">
                    I_${industry.id} -> C_${cargo.id}_${industry.id} [
                        weight="${len(doc_helper.cargos_produced_by_industry(industry, economy))}"
                        tooltip="${doc_helper.get_industry_name(industry, economy)} -> ${doc_helper.get_cargo_name(cargo)}"
                        color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                        dir=back
                        arrowtail=nonenoneinv
                        arrowsize=2
                        penwidth=3
                    ]
                    C_${cargo.id}_${industry.id} [
                        shape="ellipse"
                        label="${doc_helper.get_cargo_name(cargo)}"
                        href="cargos.html#${cargo.id}"
                        target="_top"
                        fontname="sans-serif"
                        id="${cargo.id}"
                    ]
                </tal:supply_output>-->
                <tal:not_banned condition="(cargo.id not in banned_cargos) and (cargo.id not in doc_helper.get_cargoflow_supply_cargos())">
                    I_${industry.id} -> C_${cargo.id} [
                        weight="${len(doc_helper.cargos_produced_by_industry(industry, economy))}"
                        tooltip="${doc_helper.get_industry_name(industry, economy)} -> ${doc_helper.get_cargo_name(cargo)}"
                        color="${doc_helper.get_cargo_colour_as_hex_triple_with_hash(cargo, economy)}"
                        dir=back
                        arrowtail=none
                        #arrowtail=nonenoneinv
                        arrowsize=2
                        penwidth=5
                    ]
                </tal:not_banned>
            </tal:produced_cargos>
        </tal:not_town_industries>
    </tal:industries>

    T_towns_food [
        shape="box"
        label="Towns"
        fontname="sans-serif"
        fontcolor=orange
        fontsize=32
        color=orange
        penwidth=5
        margin=1
    ]
    C_food -> T_towns_food [
        color=orange
        penwidth=5
        arrowsize=2
    ]
    subgraph cluster_town_industries {
        color="azure3"
        style="filled"
        fillcolor="azure2"
        rank="max";
        T_town_industries [
            shape="box"
            label="Towns"
            fontname="sans-serif"
            fontcolor=black
            fontsize=32
            style="filled"
        ]
        <!--!
        <tal:industries repeat="industry sorted(economy_schemas[economy].enabled_industries, key=doc_helper.get_industry_name)">
            <tal:town_industries condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                I_${industry.id} [
                    shape=none
                    label=<
                        <table border="0" cellborder="1" cellspacing="0" cellpadding="0" COLOR="azure3">
                            <tr><td><table BGCOLOR="ghostwhite" border="0" cellborder="0" cellspacing="5" cellpadding="0">
                                <tr><td>${doc_helper.get_industry_name(industry, economy)}</td></tr>
                                <tal:cargos repeat="cargo doc_helper.cargos_accepted_by_industry(industry, economy)">
                                     <tal:supplies condition="cargo.id in supply_cargos">
                                        <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                    </tal:supplies>
                                    <tal:banned condition="(cargo.id in banned_cargos) and not getattr(industry, 'town_industry_for_cargoflow', False)">
                                        <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                    </tal:banned>
                                    <tal:town_industries condition="getattr(industry, 'town_industry_for_cargoflow', False)">
                                        <tr><td>Requires ${doc_helper.get_cargo_name(cargo)}</td></tr>
                                    </tal:town_industries>
                                </tal:cargos>
                            </table></td></tr>
                        </table>
                    >
                    id="${industry.id}"
                    href="industries.html#${industry.id}"
                    target="_top"
                    fontname="sans-serif"
                    tooltip="${doc_helper.get_industry_name(industry, economy)}"
                ]
            </tal:town_industries>
        </tal:industries>
        -->
    }
    <tal:force_tropic_basic condition="economy.id == 'BASIC_TROPIC'">
        { rank=same; I_nitrate_mine I_coffee_estate, I_ranch, I_arable_farm}
        { rank=same; I_food_processor, I_stockyard, I_flour_mill}
        { rank=same; I_port, C_food, I_fishing_harbour, C_fish}
        { rank=sink; C_goods}
        subgraph cluster_elephant {
            color=white
            I_chemical_plant
            I_oil_wells
            I_nitrate_mine
            I_copper_mine
            C_chemicals
            I_copper_refinery
            C_copper_ore
            subgraph cluster_omega {
                color=white
                rank=same
                C_nitrates
                C_oil
            }
        }
        subgraph cluster_zebra {
            color=white
            rank=same
            C_fruits
            C_beans
        }
        subgraph cluster_rabbit {
            color=white
            rank=same
            C_wool
            C_coffee
            C_alcohol
            C_copper
        }
    </tal:force_tropic_basic>
    <tal:force_steeltown condition="economy.id == 'STEELTOWN'">
        { group="cabbage"; I_basic_oxygen_furnace, I_electric_arc_furnace}
        { group="cabbage2"; C_pig_iron}
        { rank=source; I_potash_mine, I_quarry, I_farm, I_coal_mine}
        { rank=same; I_chlor_alkali_plant, I_lime_kiln, I_cryo_plant}
        { rank=same; I_wire_and_section_mill, I_sheet_and_pipe_mill}
        { rank=same; C_cleaning_agents, C_zinc, C_cement}
        { rank=same; C_plastics, C_alloy_steel, C_stainless_steel, C_glass, C_sulphur, C_aluminium}
        { rank=max; I_assembly_plant, C_vehicles}
        subgraph cluster_foo {
            subgraph {
                rank=same
                I_blast_furnace
                C_pig_iron
                I_basic_oxygen_furnace
            }
        }
        subgraph cluster_kingdom {
            color=white
            rank=same
            C_oxygen
            C_quicklime
        }
        subgraph cluster_eggs {
            subgraph {
                rank=same
                I_junk_yard
                C_scrap_metal
                I_electric_arc_furnace
            }
        }

        subgraph cluster_bar {
            color=white
            subgraph {
                rank=source
                I_quarry
                I_limestone_mine
            }
        }
        subgraph cluster_jelly {
            color=white
            I_bulk_terminal
            C_food
            C_chlorine
            C_potash
        }
        subgraph cluster_domino {
            color=white
            subgraph {
                rank=same
                C_pipe
                C_steel_sections
                C_cement
                C_lye
            }
            I_wharf
        }
        subgraph cluster_gamma {
            rank=same
            C_coal
            I_coal_mine
            I_coke_oven
        }
        subgraph cluster_freda {
            color=white
            rank=same
            C_carbon_steel
            C_acid
        }
        subgraph cluster_simon {
            subgraph {
                rank=source;
                C_coal_tar
                I_carbon_black_plant
                C_carbon_black
            }
        }
        subgraph cluster_magnet {
            color=white
            subgraph {
                rank=source;
                C_stainless_steel
                C_alloy_steel
                C_plastics
                C_electrical_parts
            }
        }
        subgraph {
            color=white
            rank=same
            I_component_factory
            I_body_plant
            I_engine_plant
            I_tyre_plant
        }
        subgraph cluster_nurse {
            color=white
            subgraph {
                rank=same;
                C_glass
                C_paints_and_coatings
                C_steel_sheet
            }
        }
        subgraph cluster_ox {
            color=white
            subgraph {
                rank=source
                C_sulphur
                C_rubber
                C_steel_wire_rod
            }
        }
        subgraph cluster_victor {
            color=white
            subgraph {
                rank=source;
                C_aluminium
                C_cast_iron
            }
        }
        subgraph cluster_bob {
            color=white
            I_assembly_plant
            C_vehicle_parts
            C_tyres
            C_vehicle_engines
            C_vehicle_bodies
        }
    </tal:force_steeltown>
}
</tal:economies>
